
function anomalyLikelihood = sequentialAnomalyDectection (anomalyScores, displayFlag, labelStart)
% This function detects anomalies in a sequence of raw scores according the
% method outlined in "Real-Time Anomaly Detection for Streaming Analytics",
% arXiv:1607.02480v1 [cs.AI] 8 Jul 2016
% The input is a vector of raw scores and output is a zero-one vector of
% decisions with 1 denoting the points where an anomaly was detected.

N = length(anomalyScores);

%% Incrementally estimate mean and standard deviation
% The problem, together with a better solution, is described in Donald Knuth's "The Art of Computer Programming, Volume 2: Seminumerical Algorithms", section 4.2.2. The solution is
% to compute mean and standard deviation using a recurrence relation, like this:
% M(1) = x(1), M(k) = M(k-1) + (x(k) - M(k-1)) / k
%  S(1) = 0, S(k) = S(k-1) + (x(k) - M(k-1)) * (x(k) - M(k))
% for 2 <= k <= n, then
% sigma = sqrt(S(n) / (n - 1))
% Knuth attributes this method to B.P. Welford, Technometrics, 4,(1962), 419-420.

mu = zeros(N, 1);
sigma = zeros(N, 1);
trN = 1;
mu (trN) = anomalyScores(trN); sigma (trN) = 0.2;
for (k=trN+1:N)
    mu (k) = ((k-1-trN)*  mu(k-1) + anomalyScores(k))/(k-trN);
    sigma (k) = sigma (k-1) + (anomalyScores(k) - mu(k))*(anomalyScores(k) - mu(k));
end;
sigma = sqrt(sigma./[1:trN,1:N-trN]');
%% Ignore scores upto this point

trN = min(labelStart, min (600, round(0.15*N)));


%% Short term filter (smooth) the raw scores
% chossing median over mean did not result in better performance
% shortW = 30, 20, 10, 5 -- resulted in worse performance.
shortW = ;
filteredScores = zeros (N, 1);
for (k = shortW+1 : N)
    filteredScores (k) = sum(anomalyScores(k-shortW : k))/shortW;
end;


%% Compute tail anomalyLikelihood

zScores = (filteredScores - mu)./(sigma); zScores(1:trN) = 0;
zScores = (zScores > 0).*zScores; % keep only positive zScores

anomalyLikelihood = 1 - exp(-zScores.^2/2); %erf(zScores); %1 - 2*qfunc(zScores);
anomalyLikelihood (1:trN) = 0;

%%%

if displayFlag
    subplot(6,1,4); plot(filteredScores); title ('Short Term mean');axis('tight');
    subplot(6,1,4); hold on; plot(mu, 'g'); title ('Short Term mean');axis('tight');
    subplot(6,1,4); hold on; plot(mu-sigma, 'm'); title ('Short Term mean'); hold off; axis('tight');
    subplot(6,1,4); hold on; plot(mu+sigma, 'm'); title ('Short Term mean'); hold off; axis('tight');
    subplot(6,1,6); plot(anomalyLikelihood,'g'); title ('Anomaly Likelihood'); hold off; axis([0 N 0 1]);
    subplot(6,1,5); plot(zScores,'b'); title ('z scores'); hold off; axis('tight');
end